import type { NextPage } from "next";
import Head from "next/head";
import { ChangeEvent, useEffect, useState, useRef } from "react";
import { FastAverageColor } from "fast-average-color";

const Home: NextPage = () => {
  return (
    <>
      <Head>
        <title>Create T3 App</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className="container mx-auto flex h-screen flex-col items-center justify-center p-4">
        <UploadImages />
      </main>
    </>
  );
};

const UploadImages = () => {
  const cardRef = useRef<HTMLDivElement>(null);

  const [images, setImages] = useState<Array<File>>([]);
  const [imageURLS, setImageURLS] = useState<Array<string>>([]);
  const [textColor, setTextColor] = useState<string>("#000");

  useEffect(() => {
    setImageURLS(images.map((image) => URL.createObjectURL(image)));
  }, [images]);

  const onImageChange = (event: ChangeEvent<HTMLInputElement>) => {
    const { files } = event.target;
    if (files) {
      setImages(Array.from(files));
    }
  };

  const setBackgroundColor = (imageURL: string) => {
    const fac = new FastAverageColor();
    const card = cardRef.current;

    fac.getColorAsync(imageURL).then((color) => {
      if (card) {
        card.style.backgroundColor = color.rgba;
        setTextColor(color.isDark ? "#fff" : "#000");
      }
    });
  };

  return (
    <>
      <input
        type="file"
        accept="image/*"
        onChange={onImageChange}
        className="block text-sm text-slate-500 file:mr-4 file:rounded-full file:border-0 file:bg-violet-50 file:py-2 file:px-4 file:text-sm file:font-semibold file:text-violet-700 hover:file:bg-violet-100"
      />
      {imageURLS.map((imageURL, index) => (
        <div
          ref={cardRef}
          className="my-4 flex aspect-[9/16] h-5/6 flex-col place-content-center bg-slate-100"
          key={index}
        >
          <div
            contentEditable="true"
            className={`aspect-[9/1.333333] text-center text-[4vh] font-bold leading-relaxed text-[${textColor}] outline-none`}
          >
            Enter text here
          </div>
          {/* eslint-disable-next-line @next/next/no-img-element */}
          <img
            src={imageURL}
            alt={`uploaded image`}
            className="aspect-[9/6] object-cover object-top"
            onLoad={() => setBackgroundColor(imageURL)}
          />
          <div
            contentEditable="true"
            className={`aspect-[9/1.333333] text-center text-[4vh] font-bold leading-relaxed text-[${textColor}] outline-none`}
          >
            Enter text here
          </div>
          {/* eslint-disable-next-line @next/next/no-img-element */}
          <img
            src={imageURL}
            alt={`uploaded image`}
            className="aspect-[9/6] object-cover object-bottom"
          />
          <div
            contentEditable="true"
            className={`aspect-[9/1.333333] text-center text-[4vh] font-bold leading-relaxed text-[${textColor}] outline-none`}
          >
            Enter text here
          </div>
        </div>
      ))}
    </>
  );
};

export default Home;
